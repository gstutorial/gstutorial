<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.S. Tutorial - Classes 8, 9, 10</title>
    <style>
        /* ===== CSS RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        :root {
            --primary-blue: #3b82f6;
            --primary-green: #22c55e;
            --primary-yellow: #f59e0b;
            --primary-purple: #8b5cf6;
            --primary-red: #ef4444;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1f35 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== FIXED HEADER ===== */
        #app-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--dark-border);
            z-index: 1000;
            padding: 12px 20px;
        }

        #app-header.active {
            display: block;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 1.3rem;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.7);
            padding: 6px 12px;
            border-radius: var(--radius-full);
            border: 1px solid var(--dark-border);
            font-size: 0.9rem;
        }

        .user-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .header-logout-btn {
            padding: 6px 15px;
            font-size: 0.8rem;
        }

        /* ===== SCREEN MANAGER ===== */
        .screen {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== LOGIN SCREEN ===== */
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-xl), 0 0 40px rgba(59, 130, 246, 0.1);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .logo {
            position: relative;
            z-index: 1;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .login-form {
            padding: 30px 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            background: rgba(15, 23, 42, 0.9);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .toggle-password:hover {
            color: var(--primary-blue);
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--primary-blue) 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(90deg, var(--primary-green) 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-danger {
            background: linear-gradient(90deg, var(--primary-red) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(90deg, var(--primary-yellow) 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--dark-border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-blue);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover::before {
            width: 0;
            height: 0;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-top: 16px;
            display: none;
            font-size: 0.9rem;
        }

        /* ===== CLASS SELECTION SCREEN ===== */
        #class-selection-screen {
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        .selection-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
        }

        .selection-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-message {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .selection-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .selection-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .selection-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-lg);
        }

        .selection-card.selected {
            border-color: var(--primary-green);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(30, 41, 59, 0.9) 100%);
        }

        .selection-card.selected::before {
            transform: scaleX(1);
            background: linear-gradient(90deg, var(--primary-green) 0%, #16a34a 100%);
        }

        .selection-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: inline-block;
            transition: var(--transition);
        }

        .selection-card:hover .selection-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .selection-card h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .selection-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ===== SUBJECT SELECTION SCREEN ===== */
        #subject-selection-screen {
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        /* ===== CHAPTER SELECTION SCREEN ===== */
        #chapter-selection-screen {
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        .selection-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            padding: 25px;
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow-lg);
        }

        .selection-title {
            text-align: center;
            margin-bottom: 25px;
        }

        .selection-title h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .selection-title p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 25px;
            transition: var(--transition);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .form-select option {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .btn-full {
            width: 100%;
        }

        .back-button {
            text-align: center;
            margin-top: 25px;
        }

        .chapter-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-box {
            background: rgba(15, 23, 42, 0.7);
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .questions-count {
            color: var(--primary-blue);
        }

        .time-limit {
            color: var(--primary-yellow);
        }

        .difficulty {
            color: var(--primary-green);
        }

        .chapter-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        /* ===== QUIZ QUESTION SCREEN ===== */
        #quiz-question-screen {
            min-height: 100vh;
            padding: 70px 15px 15px;
            display: flex;
            flex-direction: column;
        }

        .quiz-progress-container {
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--dark-border);
            flex-shrink: 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.7);
            padding: 6px 12px;
            border-radius: var(--radius-full);
            border: 1px solid var(--dark-border);
            font-size: 0.9rem;
        }

        .timer-warning {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .timer-critical {
            color: var(--danger);
            animation: pulse 0.5s infinite;
        }

        .progress-bar {
            height: 6px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: var(--radius-full);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .question-container {
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--dark-border);
            flex-shrink: 0;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--dark-border);
        }

        .question-number {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-purple) 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .question-chapter {
            flex: 1;
            font-size: 1rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 25px;
        }

        .options-container {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
            flex: 1;
            overflow-y: auto;
            max-height: 50vh;
            padding-right: 5px;
        }

        .option {
            background: rgba(15, 23, 42, 0.7);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-md);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .option:hover {
            border-color: var(--primary-blue);
            transform: translateX(3px);
        }

        .option:hover::before {
            opacity: 1;
        }

        .option.selected {
            border-color: var(--primary-blue);
            background: rgba(59, 130, 246, 0.15);
        }

        .option.correct {
            border-color: var(--primary-green);
            background: rgba(34, 197, 94, 0.15);
        }

        .option.incorrect {
            border-color: var(--primary-red);
            background: rgba(239, 68, 68, 0.15);
        }

        .option-label {
            width: 32px;
            height: 32px;
            background: var(--dark-border);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            flex-shrink: 0;
            z-index: 1;
        }

        .option.selected .option-label {
            background: var(--primary-blue);
            color: white;
        }

        .option.correct .option-label {
            background: var(--primary-green);
            color: white;
        }

        .option.incorrect .option-label {
            background: var(--primary-red);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text-primary);
            z-index: 1;
            line-height: 1.4;
        }

        .explanation-box {
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid var(--primary-blue);
            display: none;
            flex-shrink: 0;
        }

        .explanation-title {
            color: var(--primary-blue);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-text {
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .quiz-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0;
        }

        .quiz-controls .btn {
            padding: 12px;
            font-size: 0.9rem;
        }

        /* ===== RESULTS SCREEN ===== */
        #results-screen {
            min-height: 100vh;
            padding: 80px 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .results-container {
            width: 100%;
            max-width: 500px;
            background: var(--dark-card);
            border-radius: var(--radius-xl);
            padding: 30px;
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow-xl);
            animation: fadeIn 0.5s ease;
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-green) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .results-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto 25px;
        }

        .score-circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary-green) 0% var(--percentage, 0%), var(--dark-border) 0%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-circle-bg::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            background: var(--dark-card);
            border-radius: 50%;
        }

        .score-value {
            position: relative;
            z-index: 1;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-green);
            margin-bottom: 4px;
        }

        .score-percentage {
            position: relative;
            z-index: 1;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            border: 1px solid var(--dark-border);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .results-message {
            background: rgba(59, 130, 246, 0.1);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            text-align: center;
        }

        .message-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .message-subtext {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .results-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* ===== LOADER ===== */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loader.active {
            display: flex;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--dark-border);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loader-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            #app-header {
                padding: 10px 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .header-left h1 {
                font-size: 1.1rem;
            }

            .header-left p {
                font-size: 0.7rem;
            }

            .header-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .user-info {
                font-size: 0.8rem;
                padding: 5px 10px;
            }

            .container {
                padding: 15px;
            }

            #class-selection-screen,
            #subject-selection-screen,
            #chapter-selection-screen,
            #quiz-question-screen,
            #results-screen {
                padding-top: 70px;
            }

            .login-container {
                margin: 0 10px;
            }

            .login-header {
                padding: 25px 15px;
            }

            .logo h1 {
                font-size: 1.8rem;
            }

            .logo p {
                font-size: 0.8rem;
            }

            .login-form {
                padding: 25px 15px;
            }

            .selection-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .selection-card {
                padding: 18px;
            }

            .selection-card h3 {
                font-size: 1.2rem;
            }

            .selection-card p {
                font-size: 0.85rem;
            }

            .selection-container {
                padding: 20px 15px;
                margin: 0 10px;
            }

            .selection-title h2 {
                font-size: 1.3rem;
            }

            .question-text {
                font-size: 1rem;
            }

            .option {
                padding: 12px;
                gap: 10px;
            }

            .option-label {
                width: 28px;
                height: 28px;
                font-size: 0.85rem;
            }

            .option-text {
                font-size: 0.9rem;
            }

            .results-container {
                padding: 25px 20px;
                margin: 0 10px;
            }

            .results-stats {
                grid-template-columns: 1fr;
            }

            .score-circle-container {
                width: 140px;
                height: 140px;
            }

            .score-circle-bg::before {
                width: 100px;
                height: 100px;
            }

            .score-value {
                font-size: 1.8rem;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .quiz-controls {
                grid-template-columns: 1fr;
            }
            
            .chapter-info-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .info-box {
                padding: 10px;
            }
            
            .results-actions {
                grid-template-columns: 1fr;
            }
            
            .question-chapter {
                font-size: 0.9rem;
            }
            
            .question-number {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .p-20 { padding: 20px; }
        .p-30 { padding: 30px; }
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
    </style>
</head>
<body>
    <!-- ===== FIXED HEADER ===== -->
    <header id="app-header">
        <div class="header-content">
            <div class="header-left">
                <h1>G.S. Tutorial</h1>
                <p>App created by Gobind Sharma</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span class="user-name" id="header-user-name">Student</span>
                </div>
                <button id="header-logout-btn" class="btn btn-danger header-logout-btn">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ===== LOADER ===== -->
    <div id="loader" class="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>

    <!-- ===== LOGIN SCREEN ===== -->
    <div id="login-screen" class="screen active">
        <div class="container">
            <div class="login-container">
                <div class="login-header">
                    <div class="logo">
                        <h1>G.S. Tutorial</h1>
                        <p>Classes 8, 9 & 10 ‚Ä¢ Science & Mathematics</p>
                    </div>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label class="form-label">
                            <span>üë§</span>
                            <span>Username</span>
                        </label>
                        <input type="text" id="login-username" class="form-input" placeholder="Enter your username" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span>üîí</span>
                            <span>Password</span>
                        </label>
                        <div class="password-container">
                            <input type="password" id="login-password" class="form-input" placeholder="Enter your password" autocomplete="current-password">
                            <button type="button" class="toggle-password" id="toggle-password">üëÅÔ∏è</button>
                        </div>
                    </div>
                    
                    <button id="login-btn" class="btn btn-primary">
                        <span>üîê</span>
                        <span>Login to Continue</span>
                    </button>
                    
                    <div id="login-error" class="error-message">
                        Invalid username or password. Please try again.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CLASS SELECTION SCREEN ===== -->
    <div id="class-selection-screen" class="screen">
        <div class="container">
            <div class="selection-header">
                <h2>Welcome, <span class="user-name-highlight" id="display-user-name">Student</span>!</h2>
                <p class="welcome-message">Please select your class to continue</p>
            </div>
            
            <div class="selection-grid">
                <div class="selection-card" data-type="class" data-value="class8">
                    <div class="selection-icon">üéí</div>
                    <h3>Class 8</h3>
                    <p>For students studying in Class 8. Access Science and Mathematics chapters tailored for Class 8 curriculum.</p>
                </div>
                
                <div class="selection-card" data-type="class" data-value="class9">
                    <div class="selection-icon">üìö</div>
                    <h3>Class 9</h3>
                    <p>For students studying in Class 9. Comprehensive coverage of Class 9 Science and Mathematics syllabus.</p>
                </div>
                
                <div class="selection-card" data-type="class" data-value="class10">
                    <div class="selection-icon">üéì</div>
                    <h3>Class 10</h3>
                    <p>For students studying in Class 10. Prepare for board exams with detailed chapter-wise practice.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SUBJECT SELECTION SCREEN ===== -->
    <div id="subject-selection-screen" class="screen">
        <div class="container">
            <div class="selection-container">
                <div class="selection-title">
                    <h2>Select Subject</h2>
                    <p>Choose a subject for <span id="selected-class-display">Class 8</span></p>
                </div>
                
                <div class="selection-grid">
                    <div class="selection-card" data-type="subject" data-value="science">
                        <div class="selection-icon">üî¨</div>
                        <h3>Science</h3>
                        <p>Physics, Chemistry, and Biology chapters with detailed explanations and MCQs for comprehensive learning.</p>
                    </div>
                    
                    <div class="selection-card" data-type="subject" data-value="mathematics">
                        <div class="selection-icon">üìê</div>
                        <h3>Mathematics</h3>
                        <p>Algebra, Geometry, Arithmetic, and Statistics chapters with step-by-step solutions and practice questions.</p>
                    </div>
                </div>
                
                <div class="back-button">
                    <button id="back-to-class-btn" class="btn btn-outline">
                        <span>‚Üê</span>
                        <span>Back to Class Selection</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CHAPTER SELECTION SCREEN ===== -->
    <div id="chapter-selection-screen" class="screen">
        <div class="container">
            <div class="selection-container">
                <div class="selection-title">
                    <h2>Select Chapter</h2>
                    <p>Choose a chapter from <span id="selected-subject-display">Science</span> for <span id="current-class-display">Class 8</span></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span>üìö</span>
                        <span>Select Chapter</span>
                    </label>
                    <select id="chapter-select" class="form-select">
                        <option value="">-- Please select a chapter --</option>
                    </select>
                </div>
                
                <div class="chapter-info" id="chapter-info" style="display: none;">
                    <div class="chapter-info-grid">
                        <div class="info-box">
                            <div class="info-label">Questions</div>
                            <div class="info-value questions-count" id="questions-count">0</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Time Limit</div>
                            <div class="info-value time-limit" id="time-limit">0 min</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Difficulty</div>
                            <div class="info-value difficulty" id="difficulty">Easy</div>
                        </div>
                    </div>
                    <div class="chapter-description" id="chapter-description"></div>
                </div>
                
                <button id="start-quiz-btn" class="btn btn-primary btn-full" disabled>
                    <span>‚ñ∂</span>
                    <span>Start Quiz</span>
                </button>
                
                <div class="back-button">
                    <button id="back-to-subject-btn" class="btn btn-outline">
                        <span>‚Üê</span>
                        <span>Back to Subject Selection</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== QUIZ QUESTION SCREEN ===== -->
    <div id="quiz-question-screen" class="screen">
        <div class="container">
            <div class="quiz-progress-container">
                <div class="progress-header">
                    <div class="progress-title" id="quiz-title">Chapter Quiz</div>
                    <div class="timer-container">
                        <span>‚è∞</span>
                        <span id="timer-display">00:00</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-info">
                    <span id="current-question-info">Question 0/0</span>
                    <span id="score-info">Score: 0</span>
                </div>
            </div>
            
            <div class="question-container">
                <div class="question-header">
                    <div class="question-number" id="question-number">1</div>
                    <div class="question-chapter" id="question-chapter">Chapter: Loading...</div>
                </div>
                <div class="question-text" id="question-text">
                    Loading question...
                </div>
            </div>
            
            <div class="options-container" id="options-container">
                <!-- Options will be dynamically loaded here -->
            </div>
            
            <div class="explanation-box" id="explanation-box">
                <div class="explanation-title">
                    <span>üìù</span>
                    <span>Explanation</span>
                </div>
                <div class="explanation-text" id="explanation-text">
                    Loading explanation...
                </div>
            </div>
            
            <div class="quiz-controls">
                <button id="prev-btn" class="btn btn-outline">
                    <span>‚Üê</span>
                    <span>Previous</span>
                </button>
                <button id="next-btn" class="btn btn-outline">
                    <span>Next</span>
                    <span>‚Üí</span>
                </button>
                <button id="submit-btn" class="btn btn-primary">
                    <span>‚úì</span>
                    <span>Submit Answer</span>
                </button>
                <button id="finish-btn" class="btn btn-warning">
                    <span>üèÅ</span>
                    <span>Finish Quiz</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== RESULTS SCREEN ===== -->
    <div id="results-screen" class="screen">
        <div class="container">
            <div class="results-container">
                <div class="results-header">
                    <h2 class="results-title">Quiz Completed!</h2>
                    <p class="results-subtitle">Great effort! Here are your results</p>
                </div>
                
                <div class="score-display">
                    <div class="score-circle-container">
                        <div class="score-circle-bg" id="score-circle">
                            <div class="score-value" id="final-score">0</div>
                            <div class="score-percentage" id="final-percentage">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="results-stats" id="results-stats">
                    <!-- Stats will be dynamically loaded here -->
                </div>
                
                <div class="results-message" id="results-message">
                    <div class="message-text" id="message-text">Loading your performance analysis...</div>
                    <div class="message-subtext" id="message-subtext">Keep practicing to improve your score!</div>
                </div>
                
                <div class="results-actions">
                    <button id="retry-btn" class="btn btn-primary">
                        <span>üîÑ</span>
                        <span>Retry This Chapter</span>
                    </button>
                    <button id="new-chapter-btn" class="btn btn-secondary">
                        <span>üìö</span>
                        <span>Try Another Chapter</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let appData = null;
        let selectedClass = null;
        let selectedSubject = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let totalQuestions = 0;
        let timeRemaining = 0;
        let timerInterval = null;
        let currentChapterFile = null;
        let currentChapterTitle = null;
        let quizStartTime = null;
        let currentChapters = [];
        let answeredQuestions = new Set();

        // ===== DOM ELEMENTS =====
        const screens = {
            login: document.getElementById('login-screen'),
            classSelection: document.getElementById('class-selection-screen'),
            subjectSelection: document.getElementById('subject-selection-screen'),
            chapterSelection: document.getElementById('chapter-selection-screen'),
            quizQuestion: document.getElementById('quiz-question-screen'),
            results: document.getElementById('results-screen')
        };

        const appHeader = document.getElementById('app-header');
        const loader = document.getElementById('loader');

        // Login screen elements
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');

        // Class selection elements
        const displayUserName = document.getElementById('display-user-name');
        const classCards = document.querySelectorAll('#class-selection-screen .selection-card');

        // Subject selection elements
        const selectedClassDisplay = document.getElementById('selected-class-display');
        const subjectCards = document.querySelectorAll('#subject-selection-screen .selection-card');
        const backToClassBtn = document.getElementById('back-to-class-btn');

        // Chapter selection elements
        const selectedSubjectDisplay = document.getElementById('selected-subject-display');
        const currentClassDisplay = document.getElementById('current-class-display');
        const chapterSelect = document.getElementById('chapter-select');
        const chapterInfo = document.getElementById('chapter-info');
        const questionsCount = document.getElementById('questions-count');
        const timeLimit = document.getElementById('time-limit');
        const difficulty = document.getElementById('difficulty');
        const chapterDescription = document.getElementById('chapter-description');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const backToSubjectBtn = document.getElementById('back-to-subject-btn');

        // Quiz question screen elements
        const quizTitle = document.getElementById('quiz-title');
        const timerDisplay = document.getElementById('timer-display');
        const progressFill = document.getElementById('progress-fill');
        const currentQuestionInfo = document.getElementById('current-question-info');
        const scoreInfo = document.getElementById('score-info');
        const questionNumber = document.getElementById('question-number');
        const questionChapter = document.getElementById('question-chapter');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const explanationBox = document.getElementById('explanation-box');
        const explanationText = document.getElementById('explanation-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const finishBtn = document.getElementById('finish-btn');

        // Results screen elements
        const scoreCircle = document.getElementById('score-circle');
        const finalScore = document.getElementById('final-score');
        const finalPercentage = document.getElementById('final-percentage');
        const resultsStats = document.getElementById('results-stats');
        const messageText = document.getElementById('message-text');
        const messageSubtext = document.getElementById('message-subtext');
        const retryBtn = document.getElementById('retry-btn');
        const newChapterBtn = document.getElementById('new-chapter-btn');

        // Header elements
        const headerUserName = document.getElementById('header-user-name');
        const headerLogoutBtn = document.getElementById('header-logout-btn');

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            showLoader();
            
            try {
                // Load app data
                const response = await fetch('topics.json');
                if (!response.ok) {
                    console.warn('topics.json not found, using default data');
                    appData = getDefaultData();
                } else {
                    appData = await response.json();
                }
                
                // Initialize the app
                initializeApp();
                hideLoader();
            } catch (error) {
                console.error('Initialization error:', error);
                appData = getDefaultData();
                initializeApp();
                hideLoader();
            }
        });

        function getDefaultData() {
            return {
                classes: [
                    {
                        id: "class8",
                        name: "Class 8",
                        subjects: [
                            {
                                id: "science",
                                name: "Science",
                                chapters: [
                                    {
                                        name: "Crop Production and Management",
                                        file: "chapters/class8_science_chapter1.xml",
                                        description: "Learn about agricultural practices, crop production, and management techniques.",
                                        difficulty: "Medium"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };
        }

        function initializeApp() {
            setupEventListeners();
            loginUsername.focus();
            console.log('G.S. Tutorial App initialized successfully');
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Login screen
            loginBtn.addEventListener('click', handleLogin);
            loginPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            togglePasswordBtn.addEventListener('click', togglePasswordVisibility);

            // Class selection
            classCards.forEach(card => {
                card.addEventListener('click', handleClassCardClick);
            });

            // Subject selection
            subjectCards.forEach(card => {
                card.addEventListener('click', handleSubjectCardClick);
            });
            backToClassBtn.addEventListener('click', () => switchScreen('classSelection'));

            // Chapter selection
            chapterSelect.addEventListener('change', handleChapterSelect);
            startQuizBtn.addEventListener('click', startChapterQuiz);
            backToSubjectBtn.addEventListener('click', () => switchScreen('subjectSelection'));

            // Header
            headerLogoutBtn.addEventListener('click', handleLogout);

            // Quiz question screen
            prevBtn.addEventListener('click', goToPreviousQuestion);
            nextBtn.addEventListener('click', goToNextQuestion);
            submitBtn.addEventListener('click', submitAnswer);
            finishBtn.addEventListener('click', finishQuiz);

            // Results screen
            retryBtn.addEventListener('click', retryQuiz);
            newChapterBtn.addEventListener('click', () => switchScreen('chapterSelection'));
        }

        // ===== SCREEN MANAGEMENT =====
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            screens[screenName].classList.add('active');
            
            if (screenName === 'login') {
                appHeader.classList.remove('active');
            } else {
                appHeader.classList.add('active');
            }
            
            switch(screenName) {
                case 'classSelection':
                    resetClassSelection();
                    break;
                case 'subjectSelection':
                    loadSubjectsForClass();
                    break;
                case 'chapterSelection':
                    loadChaptersForSubject();
                    break;
                case 'quizQuestion':
                    startQuizTimer();
                    break;
                case 'results':
                    calculateResults();
                    break;
            }
        }

        // ===== LOADER FUNCTIONS =====
        function showLoader(message = 'Loading...') {
            loader.querySelector('.loader-text').textContent = message;
            loader.classList.add('active');
        }

        function hideLoader() {
            loader.classList.remove('active');
        }

        // ===== LOGIN FUNCTIONS =====
        async function handleLogin() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();

            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }

            showLoader('Authenticating...');
            
            try {
                const response = await fetch('users.xml');
                if (!response.ok) {
                    console.warn('users.xml not found, using default users');
                    const defaultUsers = [
                        { username: 'admin', password: '123', name: 'G.S. Tutorial Admin', role: 'admin' },
                        { username: 'student8', password: 'pass123', name: 'Class 8 Student', role: 'student' },
                        { username: 'student9', password: 'pass456', name: 'Class 9 Student', role: 'student' },
                        { username: 'student10', password: 'pass789', name: 'Class 10 Student', role: 'student' },
                        { username: 'teacher1', password: 'teacher123', name: 'G.S. Tutorial Teacher', role: 'teacher' }
                    ];
                    
                    const user = defaultUsers.find(u => u.username === username && u.password === password);
                    
                    if (user) {
                        loginSuccessful(user);
                    } else {
                        showLoginError('Invalid username or password');
                    }
                } else {
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'application/xml');

                    const parserError = xmlDoc.getElementsByTagName('parsererror');
                    if (parserError.length > 0) {
                        console.error('XML parsing error:', parserError[0].textContent);
                        showLoginError('Error reading user data. Please check users.xml format.');
                        return;
                    }

                    const users = xmlDoc.getElementsByTagName('user');
                    let userFound = null;

                    for (let i = 0; i < users.length; i++) {
                        const user = users[i];
                        const xmlUsername = user.getElementsByTagName('username')[0]?.textContent;
                        const xmlPassword = user.getElementsByTagName('password')[0]?.textContent;

                        if (xmlUsername === username && xmlPassword === password) {
                            userFound = {
                                username: xmlUsername,
                                name: user.getElementsByTagName('name')[0]?.textContent || username,
                                role: user.getElementsByTagName('role')[0]?.textContent || 'student'
                            };
                            break;
                        }
                    }

                    if (userFound) {
                        loginSuccessful(userFound);
                    } else {
                        showLoginError('Invalid username or password');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Error loading user data. Please check users.xml file.');
            } finally {
                hideLoader();
            }
        }

        function loginSuccessful(user) {
            currentUser = user;
            hideLoginError();
            
            displayUserName.textContent = currentUser.name;
            headerUserName.textContent = currentUser.name;
            
            switchScreen('classSelection');
            
            console.log('Login successful:', currentUser);
        }

        function togglePasswordVisibility() {
            const passwordField = loginPassword;
            const type = passwordField.type === 'password' ? 'text' : 'password';
            passwordField.type = type;
            togglePasswordBtn.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
        }

        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
            loginPassword.focus();
            loginPassword.select();
        }

        function hideLoginError() {
            loginError.style.display = 'none';
        }

        // ===== CLASS SELECTION FUNCTIONS =====
        function handleClassCardClick(event) {
            const card = event.currentTarget;
            selectClassCard(card);
            
            // Auto-proceed to subject selection
            setTimeout(() => {
                goToSubjectSelection();
            }, 300);
        }

        function selectClassCard(card) {
            classCards.forEach(c => {
                c.classList.remove('selected');
            });
            
            card.classList.add('selected');
            selectedClass = card.dataset.value;
        }

        function resetClassSelection() {
            if (selectedClass) {
                const classCard = document.querySelector(`#class-selection-screen [data-value="${selectedClass}"]`);
                if (classCard) {
                    classCard.classList.add('selected');
                }
            }
        }

        function goToSubjectSelection() {
            if (!selectedClass) return;
            
            const classObj = appData.classes.find(c => c.id === selectedClass);
            selectedClassDisplay.textContent = classObj.name;
            
            switchScreen('subjectSelection');
        }

        // ===== SUBJECT SELECTION FUNCTIONS =====
        function loadSubjectsForClass() {
            if (!selectedClass) return;
            
            selectedSubject = null;
            subjectCards.forEach(card => {
                card.classList.remove('selected');
            });
        }

        function handleSubjectCardClick(event) {
            const card = event.currentTarget;
            selectSubjectCard(card);
            
            // Auto-proceed to chapter selection
            setTimeout(() => {
                goToChapterSelection();
            }, 300);
        }

        function selectSubjectCard(card) {
            subjectCards.forEach(c => {
                c.classList.remove('selected');
            });
            
            card.classList.add('selected');
            selectedSubject = card.dataset.value;
        }

        function goToChapterSelection() {
            if (!selectedClass || !selectedSubject) return;
            
            const classObj = appData.classes.find(c => c.id === selectedClass);
            const subjectObj = classObj.subjects.find(s => s.id === selectedSubject);
            
            selectedSubjectDisplay.textContent = subjectObj.name;
            currentClassDisplay.textContent = classObj.name;
            
            switchScreen('chapterSelection');
        }

        // ===== CHAPTER SELECTION FUNCTIONS =====
        async function loadChaptersForSubject() {
            if (!selectedClass || !selectedSubject) return;
            
            showLoader('Loading chapters...');
            
            try {
                const classObj = appData.classes.find(c => c.id === selectedClass);
                const subjectObj = classObj.subjects.find(s => s.id === selectedSubject);
                
                chapterSelect.innerHTML = '<option value="">-- Please select a chapter --</option>';
                chapterInfo.style.display = 'none';
                startQuizBtn.disabled = true;
                currentChapters = [];
                
                if (!subjectObj.chapters || subjectObj.chapters.length === 0) {
                    chapterSelect.innerHTML += '<option value="" disabled>No chapters available</option>';
                    return;
                }
                
                currentChapters = subjectObj.chapters;
                subjectObj.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = chapter.name;
                    chapterSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading chapters:', error);
                chapterSelect.innerHTML = '<option value="" disabled>Error loading chapters</option>';
            } finally {
                hideLoader();
            }
        }

        async function handleChapterSelect() {
            const selectedIndex = parseInt(chapterSelect.value);
            
            if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= currentChapters.length) {
                chapterInfo.style.display = 'none';
                startQuizBtn.disabled = true;
                return;
            }
            
            const chapter = currentChapters[selectedIndex];
            
            showLoader('Loading chapter details...');
            
            try {
                // Load XML to get actual question count and time limit
                const response = await fetch(chapter.file);
                if (!response.ok) {
                    throw new Error(`Failed to load ${chapter.file}`);
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
                
                // Get metadata from XML
                const metadata = xmlDoc.getElementsByTagName('metadata')[0];
                let totalQuestionsFromXML = 0;
                let timeLimitFromXML = 30; // Default 30 minutes
                
                if (metadata) {
                    const timeLimitElement = metadata.getElementsByTagName('timeLimit')[0];
                    if (timeLimitElement) {
                        timeLimitFromXML = parseInt(timeLimitElement.textContent) || 30;
                    }
                    
                    const totalQuestionsElement = metadata.getElementsByTagName('totalQuestions')[0];
                    if (totalQuestionsElement) {
                        totalQuestionsFromXML = parseInt(totalQuestionsElement.textContent) || 0;
                    }
                }
                
                // Count actual questions
                const questionNodes = xmlDoc.getElementsByTagName('question');
                const actualQuestionCount = questionNodes.length;
                
                // Use actual count if totalQuestions not specified
                const finalQuestionCount = totalQuestionsFromXML > 0 ? totalQuestionsFromXML : actualQuestionCount;
                
                // Update chapter info
                questionsCount.textContent = finalQuestionCount;
                timeLimit.textContent = `${timeLimitFromXML} min`;
                difficulty.textContent = chapter.difficulty || 'Medium';
                chapterDescription.textContent = chapter.description || 'Practice questions from this chapter to test your knowledge and improve your skills.';
                
                chapterInfo.style.display = 'block';
                startQuizBtn.disabled = false;
                
            } catch (error) {
                console.error('Error loading chapter details:', error);
                // Fallback to default values
                questionsCount.textContent = '15';
                timeLimit.textContent = '30 min';
                difficulty.textContent = chapter.difficulty || 'Medium';
                chapterDescription.textContent = chapter.description || 'Practice questions from this chapter to test your knowledge and improve your skills.';
                
                chapterInfo.style.display = 'block';
                startQuizBtn.disabled = false;
            } finally {
                hideLoader();
            }
        }

        async function startChapterQuiz() {
            const selectedIndex = parseInt(chapterSelect.value);
            
            if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= currentChapters.length) {
                return;
            }
            
            const chapter = currentChapters[selectedIndex];
            
            showLoader('Loading quiz...');
            
            try {
                const response = await fetch(chapter.file);
                if (!response.ok) {
                    throw new Error(`Failed to load ${chapter.file}`);
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
                
                // Get time limit from XML
                const metadata = xmlDoc.getElementsByTagName('metadata')[0];
                let timeLimitFromXML = 30;
                
                if (metadata) {
                    const timeLimitElement = metadata.getElementsByTagName('timeLimit')[0];
                    if (timeLimitElement) {
                        timeLimitFromXML = parseInt(timeLimitElement.textContent) || 30;
                    }
                }
                
                // Parse questions
                currentQuestions = [];
                const questionNodes = xmlDoc.getElementsByTagName('question');
                
                for (let i = 0; i < questionNodes.length; i++) {
                    const qNode = questionNodes[i];
                    const question = {
                        text: qNode.getElementsByTagName('text')[0]?.textContent || '',
                        options: [],
                        correctIndex: -1,
                        explanation: qNode.getElementsByTagName('explanation')[0]?.textContent || 'No explanation available.'
                    };
                    
                    const optionNodes = qNode.getElementsByTagName('option');
                    for (let j = 0; j < optionNodes.length; j++) {
                        const optNode = optionNodes[j];
                        question.options.push(optNode.textContent);
                        if (optNode.getAttribute('correct') === 'true') {
                            question.correctIndex = j;
                        }
                    }
                    
                    if (question.text && question.options.length >= 2 && question.correctIndex !== -1) {
                        currentQuestions.push(question);
                    }
                }
                
                if (currentQuestions.length === 0) {
                    throw new Error('No valid questions found in this chapter.');
                }
                
                // Reset quiz state
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuestions.length).fill(null);
                score = 0;
                totalQuestions = currentQuestions.length;
                timeRemaining = timeLimitFromXML * 60;
                currentChapterFile = chapter.file;
                currentChapterTitle = chapter.name;
                quizStartTime = Date.now();
                answeredQuestions.clear();
                
                quizTitle.textContent = `Chapter: ${chapter.name}`;
                questionChapter.textContent = `Chapter: ${chapter.name}`;
                
                switchScreen('quizQuestion');
                loadQuestion();
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert(`Error loading quiz: ${error.message}\nPlease check if the XML file exists and has correct format.`);
                
                // Load sample questions as fallback
                loadSampleQuestions(chapter);
            } finally {
                hideLoader();
            }
        }

        function loadSampleQuestions(chapter) {
            currentQuestions = [
                {
                    text: "Which of the following is not a kharif crop?",
                    options: ["Paddy", "Maize", "Wheat", "Soybean"],
                    correctIndex: 2,
                    explanation: "Wheat is a rabi crop, not a kharif crop. Kharif crops are sown in the rainy season (June-July) and harvested in autumn."
                },
                {
                    text: "The process of loosening and turning of soil is called:",
                    options: ["Harvesting", "Ploughing", "Irrigation", "Winnowing"],
                    correctIndex: 1,
                    explanation: "Ploughing is the process of loosening and turning the soil. It helps in proper aeration and mixing of nutrients."
                },
                {
                    text: "Which of the following is a natural fertilizer?",
                    options: ["Manure", "Urea", "NPK", "Ammonium sulphate"],
                    correctIndex: 0,
                    explanation: "Manure is a natural fertilizer obtained from the decomposition of plant and animal wastes."
                }
            ];
            
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            score = 0;
            totalQuestions = currentQuestions.length;
            timeRemaining = 30 * 60;
            currentChapterFile = chapter.file;
            currentChapterTitle = chapter.name;
            quizStartTime = Date.now();
            answeredQuestions.clear();
            
            quizTitle.textContent = `Chapter: ${chapter.name}`;
            questionChapter.textContent = `Chapter: ${chapter.name}`;
            
            switchScreen('quizQuestion');
            loadQuestion();
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                selectedClass = null;
                selectedSubject = null;
                currentQuestions = [];
                userAnswers = [];
                score = 0;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                loginUsername.value = '';
                loginPassword.value = '';
                loginPassword.type = 'password';
                togglePasswordBtn.textContent = 'üëÅÔ∏è';
                loginError.style.display = 'none';
                
                switchScreen('login');
            }
        }

        // ===== QUIZ FUNCTIONS =====
        function startQuizTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timerDisplay.classList.remove('timer-warning', 'timer-critical');
            if (timeRemaining <= 300) {
                timerDisplay.classList.add('timer-warning');
            }
            if (timeRemaining <= 60) {
                timerDisplay.classList.remove('timer-warning');
                timerDisplay.classList.add('timer-critical');
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                finishQuiz();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            
            // Update progress
            const progressPercent = ((currentQuestionIndex) / currentQuestions.length) * 100;
            progressFill.style.width = `${progressPercent}%`;
            
            // Update question info
            questionNumber.textContent = currentQuestionIndex + 1;
            currentQuestionInfo.textContent = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            scoreInfo.textContent = `Score: ${score}`;
            questionText.textContent = question.text;
            
            // Clear previous options and explanation
            optionsContainer.innerHTML = '';
            explanationBox.style.display = 'none';
            
            // Add options
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                if (userAnswers[currentQuestionIndex] === index) {
                    optionDiv.classList.add('selected');
                }
                
                optionDiv.innerHTML = `
                    <div class="option-label">${String.fromCharCode(65 + index)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                optionDiv.addEventListener('click', () => selectOption(index));
                optionsContainer.appendChild(optionDiv);
            });
            
            // Update button states
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === currentQuestions.length - 1;
            submitBtn.disabled = userAnswers[currentQuestionIndex] !== null || answeredQuestions.has(currentQuestionIndex);
            finishBtn.disabled = false;
            
            // Show explanation if already answered
            if (userAnswers[currentQuestionIndex] !== null) {
                showAnswerFeedback();
            }
            
            // Scroll to top of options
            optionsContainer.scrollTop = 0;
        }

        function selectOption(index) {
            userAnswers[currentQuestionIndex] = index;
            loadQuestion();
        }

        function showAnswerFeedback() {
            const question = currentQuestions[currentQuestionIndex];
            const selectedIndex = userAnswers[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correctIndex;
            
            const options = optionsContainer.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (index === question.correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            explanationText.textContent = question.explanation;
            explanationBox.style.display = 'block';
            
            submitBtn.disabled = true;
        }

        function submitAnswer() {
            if (userAnswers[currentQuestionIndex] === null) {
                alert('Please select an answer first.');
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const selectedIndex = userAnswers[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correctIndex;
            
            if (isCorrect) {
                score++;
                scoreInfo.textContent = `Score: ${score}`;
            }
            
            answeredQuestions.add(currentQuestionIndex);
            showAnswerFeedback();
        }

        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function goToNextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function finishQuiz() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            switchScreen('results');
        }

        // ===== RESULTS SCREEN FUNCTIONS =====
        function calculateResults() {
            // Calculate correct answers
            let correct = 0;
            let attempted = 0;
            
            for (let i = 0; i < currentQuestions.length; i++) {
                if (userAnswers[i] !== null) {
                    attempted++;
                    if (userAnswers[i] === currentQuestions[i].correctIndex) {
                        correct++;
                    }
                }
            }
            
            // Make sure score matches calculated correct answers
            score = correct;
            
            // Calculate statistics
            const total = currentQuestions.length;
            const incorrect = attempted - correct;
            const unattempted = total - attempted;
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            const timeTaken = quizStartTime ? Math.floor((Date.now() - quizStartTime) / 1000) : 0;
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            // Update score circle
            scoreCircle.style.setProperty('--percentage', `${percentage}%`);
            finalScore.textContent = correct;
            finalPercentage.textContent = `${percentage}%`;
            
            // Update statistics
            resultsStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${correct}</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${incorrect}</div>
                    <div class="stat-label">Incorrect Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${unattempted}</div>
                    <div class="stat-label">Unattempted</div>
                </div>
            `;
            
            // Update message based on performance
            let message, submessage;
            if (percentage >= 90) {
                message = "üéâ Outstanding Performance!";
                submessage = "You have mastered this chapter! Excellent work!";
            } else if (percentage >= 75) {
                message = "üëç Very Good!";
                submessage = "You have a strong understanding of this chapter. Keep it up!";
            } else if (percentage >= 60) {
                message = "üìö Good Effort!";
                submessage = "You understand the basics well. Review the explanations to improve.";
            } else if (percentage >= 40) {
                message = "üí° Room for Improvement";
                submessage = "Review the chapter material and explanations carefully.";
            } else {
                message = "üìñ Needs More Practice";
                submessage = "Take your time to study the chapter thoroughly before trying again.";
            }
            
            messageText.textContent = message;
            messageSubtext.textContent = submessage;
        }

        function retryQuiz() {
            currentQuestionIndex = 0;
            userAnswers.fill(null);
            score = 0;
            answeredQuestions.clear();
            
            switchScreen('quizQuestion');
            loadQuestion();
            startQuizTimer();
        }
    </script>
</body>
</html>
